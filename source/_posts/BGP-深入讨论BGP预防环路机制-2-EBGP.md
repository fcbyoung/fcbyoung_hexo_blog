---
title: '[BGP]深入讨论BGP预防环路机制(2) EBGP'
date: 2025-10-04 09:11:50
tags: [网络工程师,计算机网络,BGP,路由协议]
---

当一台BGP路由器将一条路由通告给一个EBGP对等体是，它必须把自己的AS好添加到该路由AS_Path列表最前面。

BGP路由器在收到一条路由时，会检查其AS_Path属性：若在该列表中发现自己的AS号，则说明这条路由到过本AS，将会形成环路。路由器会直接丢弃该路由。



接下来深入讨论一个问题：EBGP可以和IBGP一样搞水平分割吗？

直接的回答是：**可以，但EBGP防环机制的核心和主要手段并不是传统意义上的“水平分割”，而是其特有的AS_PATH路径属性。**

下面我们来详细解释：

### 1. 传统“水平分割”与EBGP

*   **传统水平分割**：在像RIP这样的距离矢量协议中，水平分割的规则是：“**从一个接口学到的路由，不会再从同一个接口发出去**”。这有效地防止了相邻路由器之间的环路。
*   **EBGP的情况**：EBGP对等体之间通常只有一条直连的物理链路或TCP连接。从这个角度看，EBGP会话本身就隐含了“水平分割”的特性——它不会把从某个EBGP对等体学来的路由，再发回给同一个对等体。因为那样做没有意义，对方本来就是这条路由的源头或中转站。

**所以，从这个狭义的角度说，EBGP在直连的对等体之间，确实有类似水平分割的行为。**

### 2. EBGP防环的核心机制：AS_PATH属性

然而，EBGP面对的网络环境远比两个直连路由器复杂。环路可能发生在多个AS之间，而不仅仅是两个直连路由器之间。这时，传统的“水平分割”就完全不够用了。

**EBGP防环的基石是 `AS_PATH` 属性。**

它的规则非常简单而有效：
**当一台BGP路由器将一条路由通告给一个EBGP对等体时，它必须把自己的AS号添加到该路由的AS_PATH列表的最前面。**

**BGP路由器在收到一条路由时，会检查其AS_PATH属性：**
*   **如果在该列表中发现了自己的AS号，说明这条路由曾经经过本AS，形成了环路。** 路由器会直接丢弃这条路由，认为它无效。

**举例说明：**
假设有这样一个路径：AS 100 -> AS 200 -> AS 300
1.  AS 100将路由 `10.0.0.0/8` 通告给AS 200。此时AS_PATH为 `[100]`。
2.  AS 200收到后，将路由通告给AS 300。在发送前，它把自己的AS号200加进去，AS_PATH变为 `[200, 100]`。
3.  AS 300收到路由，AS_PATH是 `[200, 100]`。
4.  **现在，如果AS 300错误地试图将这条路由再发回给AS 200**，它在发送前会添加自己的AS号，AS_PATH变为 `[300, 200, 100]`。
5.  当AS 200收到这条路由时，它检查AS_PATH，发现其中包含自己的AS号 `200`。于是AS 200立刻判定这条路由形成了环路，并将其丢弃。

这个机制完美地解决了在不同自治系统之间可能出现的任何环路问题。

### 3. IBGP的防环与“水平分割”

作为对比，我们可以看一下IBGP的情况，这能更好地理解“水平分割”的概念。

在同一个AS内部，IBGP对等体之间也会传递路由。为了防止在AS内部产生环路，IBGP使用了一条非常重要的规则，这条规则**非常类似于“水平分割”**：

**从一个IBGP对等体学到的路由，不会传递给其他IBGP对等体。**

这意味着，在AS内部，IBGP路由器之间必须建立**全互联**的邻居关系，或者使用路由反射器/联盟来规避这个规则。这正是为了防止在缺乏像AS_PATH这样的跨AS防环机制的情况下，路由在AS内部无休止地传递。

### 总结

| 协议/场景 | 主要防环机制                                             | 是否使用传统“水平分割”                       |
| :-------- | :------------------------------------------------------- | :------------------------------------------- |
| **RIP**   | 水平分割、毒性逆转、最大跳数                             | **是**，核心机制之一                         |
| **EBGP**  | **AS_PATH属性**                                          | 在直连对等体间有类似行为，但**不是主要机制** |
| **IBGP**  | **IBGP水平分割规则**（不从IBGP学到的路由传给另一个IBGP） | **是**，这是其核心防环规则，但特指IBGP邻居间 |

**结论：**
EBGP可以通过其会话特性在直连对等体间实现类似水平分割的效果，但其真正强大和核心的防环机制是 **AS_PATH属性**。而“水平分割”这一概念在BGP协议中，更明确地体现在 **IBGP的防环规则** 上。



换种说法，**EBGP因为常用于广域网，所以在这里建立全互联，进而建立水平分割并不现实。**

这正是网络协议设计中的一个经典权衡：**理论上的理想方案 vs. 现实中的工程可行性。**

我们可以从以下几个角度来深入理解为什么在EBGP场景下“建立全互联”不现实，从而导致它必须依赖 `AS_PATH` 而不是“IBGP式”的水平分割：

### 1. 规模与可扩展性

*   **IBGP在一个AS内**：一个自治系统（AS）内的路由器数量是有限的，可能是几十台、几百台。建立全互联的IBGP会话（会话数量公式：n*(n-1)/2）虽然也有挑战，但通过路由反射器等技术可以管理。
*   **EBGP在互联网上**：互联网由数万个AS构成。如果要求所有AS之间都建立全互联的EBGP会话，那将是一个天文数字，无论在配置复杂度、TCP连接数量还是路由表维护上，都是完全不可能实现的。互联网的架构本身就是基于**层级和互联**的，而不是一个扁平的全互联网络。

### 2. 管理与策略控制

*   **商业关系**：AS之间存在复杂的商业关系（如供应商、客户、对等体）。一个AS需要根据商业合同，精确地控制它将哪些路由通告给哪个邻居。如果建立全互联，这种精细化的策略控制将无法实现。`AS_PATH` 属性本身就是一个强大的策略工具，网络工程师可以根据AS路径长度、经过的AS等信息来决定优选哪条路径。
*   **管理域**：每个AS都是一个独立的管理域。让一个AS的管理员去和互联网上所有其他AS的管理员协调建立BGP会话，在组织和安全上都是不可行的。

### 3. 地理与拓扑

*   **物理距离**：一个AS可能位于北京，而它的对等体可能位于伦敦或纽约。它们之间的通信需要经过多个中间网络。从物理和逻辑拓扑上看，它们根本不是“直连”的，也就不存在一个单一的“接口”来应用传统的水平分割规则。`AS_PATH` 记录了整个路径，完美地适应了这种多跳、跨地域的复杂环境。

### 总结对比

让我们把这两种场景并置，就能清晰地看到设计哲学的差异：

| 场景         | **IBGP - 在一个AS内部**                                      | **EBGP - 在整个互联网上**                                    |
| :----------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| **范围**     | 单一管理域，规模有限                                         | 全球范围，数万个独立管理域                                   |
| **连接性**   | **追求/模拟全互联**（通过物理全互联或路由反射器）            | **必然是多跳、部分互联**的网状结构                           |
| **防环机制** | **IBGP水平分割规则**（因为拓扑可以模拟成全互联）             | **AS_PATH属性**（因为拓扑是网状，无法全互联）                |
| **核心思想** | **“我不知道这条路有没有环，所以我干脆不把它传回给可能知道它的人。”** （基于会话的过滤） | **“让我看看这条路的历史记录，如果上面有我自己的脚印，那我就绕回来了。”** （基于路径记录的检验） |

所以，可以做如下总结：**正是因为EBGP应用于广域网这种规模巨大、无法全互联的环境，才催生了 `AS_PATH` 这种更聪明、更可扩展的防环机制，而放弃了依赖全互联拓扑的传统“水平分割”思想。** 这是一个为了适应现实世界复杂度而进行的卓越工程设计。
