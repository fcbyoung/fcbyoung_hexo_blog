---
title: '[BGP]深入讨论BGP预防环路机制(3) BGP联盟'
date: 2025-10-04 09:18:40
tags: [网络工程师,计算机网络,BGP,路由协议]
---

好的，这是一个非常核心的BGP进阶概念。我们来详细拆解一下这句话：“BGP通过AS内部使用联盟，以此防止环路”。

为了理解它，我们需要分三步走：

1.  **BGP的防环路基础机制**
2.  **在单个AS内部（iBGP）遇到的问题**
3.  **联盟如何解决这个问题并防止环路**

---

### 1. BGP的防环路基础机制：AS_PATH

BGP是一种“路径矢量”路由协议，它防环路的核心机制是 **AS_PATH** 属性。

*   **工作原理**：当BGP路由器向外部的AS通告一条路由时，会把自己的**AS号** 添加到AS_PATH列表的最前面。
*   **环路检测**：当一台BGP路由器收到一条路由更新时，它会检查AS_PATH列表。**如果在这个列表中发现了自己的AS号，它就认为这条路由产生了环路，从而丢弃该路由。**

**举个例子：**
假设AS 100 -> AS 200 -> AS 300。
当路由从AS 100传到AS 200时，AS_PATH是 `100`。
当AS 200再传给AS 300时，AS_PATH变成 `200 100`。
如果AS 300试图把这条路由再传回给AS 200，AS 200会在AS_PATH `300 200 100` 中看到自己的AS号 `200`，于是它会拒绝接受这条路由，防止了环路。

---

### 2. 在单个AS内部（iBGP）遇到的问题

在一个AS内部，路由器之间使用**iBGP** 来交换BGP路由信息。iBGP有一个非常重要的规则，叫做：

**“从一台iBGP对等体学到的路由，永远不会传递给另一台iBGP对等体。”**

这被称为 **BGP Split-Horizon**。

**为什么要有这个规则？**
因为在AS内部，**没有AS号被添加到AS_PATH中**！回想一下防环路机制，它是基于AS_PATH来检测的。如果在同一个AS内，路由器之间互相传递路由，AS_PATH不会改变，BGP就无法通过AS_PATH来检测环路。为了防止在AS内部产生路由环路，所以干脆定下这个“死规矩”：iBGP邻居之间传一次就够了，不许二次传播。

**这个规则带来的问题：**
为了保证AS内所有BGP路由器都能学到完整的路由信息，**所有运行iBGP的路由器之间必须形成全互联的邻居关系**。这在一个大型AS中会带来巨大的管理和性能开销（比如有N台路由器，就需要建立 N*(N-1)/2 个iBGP会话）。

---

### 3. 联盟如何解决这个问题并防止环路

**联盟（BGP Confederations）** 就是为了解决上述“iBGP全互联”问题而设计的一种方法。

**它的核心思想是：** **“化整为零”**。把一个大的AS（我们称之为**联盟AS**）划分成多个小的、更容易管理的AS（我们称之为**子AS** 或 **成员AS**）。

**具体做法：**

1.  **划分**：将原来的大AS 65000，划分为几个子AS，例如 AS 65001, AS 65002, AS 65003。
2.  **对外表现**：对于**联盟外部**的BGP对等体来说，整个联盟仍然被看作**一个单一的AS 65000**。它们完全不知道内部被划分了。
3.  **内部运行**：在**联盟内部**，这些子AS之间使用一种特殊的**eBGP** 来交换路由信息。注意，它不是标准的eBGP，而是经过修改的，我们称之为 ** Confederation eBGP**。

#### **联盟如何防止环路？**

这里就是最关键的部分了。联盟通过引入两个概念来防止环路：

**a) AS_CONFED_SEQUENCE**

这是一个类似于AS_PATH的BGP路径属性，但它只在联盟内部使用。
*   当路由在一个子AS（如AS 65001）内传播时，AS_PATH不会改变。
*   但当路由从一个子AS（AS 65001）传到另一个子AS（AS 65002）时，**发出路由的子AS号（65001）会被添加到 AS_CONFED_SEQUENCE 这个属性中**。

**b) 联盟内部的环路检测**
在联盟内部，路由器会同时检查 **AS_PATH** 和 **AS_CONFED_SEQUENCE**。
*   如果在一台属于AS 65002的路由器收到的路由更新中，在 **AS_CONFED_SEQUENCE** 里看到了自己的子AS号 `65002`，它就会认为这条路由在联盟内部产生了环路，从而将其丢弃。

**这样一来，联盟就在大的AS内部，重新创建了一个类似于外部AS之间的防环路机制。**

#### **工作流程与好处**

*   **流程**：
    *   子AS内部：使用iBGP，遵循iBGP的规则。
    *   子AS之间：使用 Confederation eBGP。它允许像标准eBGP一样传递路由，从而**打破了iBGP全互联的要求**。你只需要在每个子AS的边界路由器之间建立eBGP对等体关系即可。
*   **好处**：
    1.  **解决了全互联问题**：大大减少了需要建立的iBGP会话数量。
    2.  **防止了AS内部环路**：通过AS_CONFED_SEQUENCE属性，在联盟内部实现了可靠的环路检测。
    3.  **策略灵活性**：可以在子AS之间应用类似于eBGP的路由策略，提供了更精细的控制。

---

### 总结

*   **根本问题**：iBGP因为AS_PATH在AS内不变，无法防环路，所以只能用“全互联”这个笨办法来规避环路，但这在大型网络中不可行。
*   **联盟的解决方案**：将大AS“伪装”成多个小AS的联合体。
*   **防环路机制**：在内部的小AS（子AS）之间通信时，使用一个**新的、只在联盟内部有效的路径属性 `AS_CONFED_SEQUENCE`** 来记录路径。路由器通过检查这个属性来判断是否在联盟内部形成了环路。

**一个简单的比喻：**
把一个有1000人的大公司（大AS）重组，分成10个部门（子AS）。
*   **以前**：为了保证信息一致，要求这1000人两两之间都要直接沟通（全互联），这根本做不到。
*   **现在**：部门内部（iBGP）自由沟通。部门之间（Confed eBGP）只派代表（边界路由器）沟通，并且每次跨部门传递消息时，都会在内部备忘录（AS_CONFED_SEQUENCE）上盖章，如果一份文件转了一圈又回到本部门，一看备忘录就知道是循环了，直接扔掉。而对于公司外部的人来说，他们仍然只认为这是一个公司（联盟AS）。



那是不是可以说，BGP联盟仅适用于IBGP，而在EBGP上不可行？

这是一个非常好的问题，它触及了BGP联盟设计的核心。

首先给出结论：这个说法完全正确，并且非常精准。我们可以这样来理解：

**BGP联盟本质上是一种用于“优化和改造大型AS内部iBGP网络”的技术。它不是为了在eBGP上使用，而是为了解决纯iBGP环境下的问题而诞生的。**

下面我来详细解释为什么：

---

### 1. 根本目的：解决iBGP的难题

正如我们之前讨论的，iBGP有两大核心问题：
*   **防环路机制缺失**：在AS内部传递时，AS_PATH不变，无法用AS_PATH防环。
*   **全互联要求**：导致管理复杂度和资源消耗巨大。

**联盟就是为了直接解决这两个iBGP特有的问题而设计的。** 如果一个AS很小，根本不需要iBGP全互联，那么联盟也就没有存在的必要。

---

### 2. 实现方式：在AS内部“模拟”eBGP

联盟的实现手法非常巧妙：**它在一个真实的AS内部，创建了多个逻辑上的“子AS”，然后在它们之间运行一种特殊的、经过修改的eBGP。**

这里的关键点是：

*   **对“外”**：对于联盟之外的、真正的eBGP对等体来说，它们看到的仍然是一个**单一的、完整的AS号**。它们完全不知道这个AS内部被划分成了多个子AS。在与外部通信时，联盟AS的行为和一个普通AS没有任何区别。
*   **对“内”**：在联盟内部，子AS之间的行为**类似于eBGP**（比如可以正常传递路由，而不需要全互联），但又**不是标准的eBGP**（比如下一跳属性、LOCAL_PREF等属性在子AS间依然保持，不像标准eBGP那样默认重置）。

所以，**联盟技术是将eBGP的某些机制“内化”为了一个解决iBGP问题的工具。**

---

### 3. 为什么说它“在eBGP上不可行”？

这个说法可以从两个层面理解：

**a) 从设计初衷和应用场景来看：**
联盟的设计目标就不是为了用于两个**真正独立的、不同所属的AS** 之间的eBGP连接。比如，你不可能告诉你的运营商：“我们在我们两个AS之间的eBGP链路上启用联盟吧。” 这是没有意义的，因为eBGP本身已经通过AS_PATH完美地解决了环路问题，并且不需要全互联。

**b) 从技术细节来看：**
如果试图在两个真正的eBGP对等体之间使用联盟，会遇到根本性的矛盾：

*   **AS号表示**：联盟使用的子AS号通常属于私有AS号范围（64512-65534）。在真正的eBGP会话中，这些私有AS号是不应该被通告给对方的。
*   **路径属性**：联盟内部使用的`AS_CONFED_SEQUENCE`路径属性，在传递给真正的eBGP对等体之前**必须被移除**。如果将它泄露给外部AS，会导致路由问题，因为外部AS无法理解这个属性。
*   **失去意义**：eBGP本身工作得很好，引入联盟机制不会带来任何好处，反而会破坏标准的防环路和工作机制。

---

### 总结与类比

让我们用一个比喻来巩固理解：

*   **一个大型公司** = 一个大的AS（例如AS 65000）
*   **公司内部的部门（如市场部、技术部）** = 子AS（AS 65001， AS 65002）
*   **公司与外部公司沟通** = eBGP
*   **公司内部的全员大会** = iBGP全互联（效率低下）
*   **联盟** = 公司重组，设立部门经理。部门内部自由沟通（子AS内的iBGP），部门经理之间开会沟通（子AS间的Confederation eBGP）。对外，公司仍然是一个整体。

**结论：**

**BGP联盟是一种专门为解决大型iBGP网络中的全互联和防环路问题而设计的技术。它通过在一个真实的AS内部引入类似eBGP的逻辑关系来实现这一目标，但它本身并不应用于两个独立AS之间的eBGP会话。** 它是“用于iBGP的eBGP-like机制”，而不是“用于eBGP的技术”。





最后，让我们再对IBGP中的全互联，反射路由器RR，以及BGP联盟三大预防环路机制进行详细对比。

---

### 对比总览

| 特性维度               | 全互联                                                       | 路由反射器                                                   | 联盟                                                       |
| :--------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- | :--------------------------------------------------------- |
| **核心思想**           | 最直接的方法，遵守基础规则                                   | **打破“不传递”规则**：指定特定路由器（RR）来反射路由         | **化整为零**：将大AS划分为小AS，内部使用“特殊eBGP”         |
| **扩展性**             | **极差**<br>会话数呈O(N²)增长                                | **优秀**<br>会话数呈O(N)线性增长                             | **良好**<br>减少了全互联范围，但比RR稍复杂                 |
| **配置与管理复杂度**   | **低**（概念简单）<br>**高**（实际维护会话多）               | **中等**<br>需要精心设计RR和客户机的拓扑                     | **高**<br>需要规划子AS，配置边界路由器                     |
| **防环机制**           | **BGP Split-Horizon**<br>（从iBGP学到的路由不传给其他iBGP对等体） | **Cluster_List** 和 **Originator_ID** 属性                   | **AS_CONFED_SEQUENCE** 属性                                |
| **路径可见性**         | AS_PATH保持原始状态，清晰明了                                | AS_PATH保持原始状态                                          | 对外隐藏内部子AS结构，AS_PATH中只显示联盟AS号              |
| **策略控制的灵活性**   | 策略在所有路由器上对等应用                                   | **集中化策略**<br>可在RR上应用策略，影响其所有客户机         | **分布式策略**<br>可在子AS边界应用类似eBGP的策略，更精细   |
| **网络稳定性与故障域** | **无单点故障**<br>一个会话断开不影响其他会话                 | **有单点故障风险**<br>一个RR故障会影响其所有客户机（可通过冗余缓解） | **故障域隔离**<br>一个子AS的问题更容易被隔离在内部         |
| **迁移难度**           | N/A（基准）                                                  | **相对容易**<br>可以逐步部署，将部分路由器设为RR的客户机     | **相对困难**<br>通常需要规划停机时间，重新划分AS并配置边界 |

---

### 深入分析各自特点

#### 1. 全互联

*   **优点**：
    *   **简单可靠**：概念上最简单，符合BGP最基础的设计。
    *   **无单点故障**：没有中心节点，任何一个iBGP会话的中断只会影响直接相连的两个路由器。
*   **缺点**：
    *   **无法扩展**：这是其致命弱点。当路由器数量超过几十台时，会话数量会变得难以管理，消耗大量内存和CPU资源。
*   **适用场景**：
    *   小型网络或实验室环境。
    *   作为衡量其他方案优劣的基准。

#### 2. 路由反射器

*   **优点**：
    *   **极佳的扩展性**：大幅减少了iBGP会话数量。是当前大型网络中最主流的解决方案。
    *   **易于部署和迁移**：可以从现有全互联网络中逐步引入RR，无需大规模重构网络。
    *   **保持逻辑拓扑**：整个AS在逻辑上仍然是一个统一的实体，对外部网络没有影响。
*   **缺点**：
    *   **可能引入单点故障**：如果RR发生故障，其下所有客户机将无法学习到完整的BGP路由。解决方案是部署多个冗余的RR。
    *   **潜在的子最优路径**：RR会向所有客户机反射最佳路径，但客户机到该路径的下一跳可能不是最优的，需要依赖IGP的收敛或开启“下一跳自我”功能。
    *   **配置复杂性**：需要精心设计RR的层级（如分层RR）和Cluster，配置不当容易引起环路。
*   **适用场景**：
    *   **绝大多数中大型企业和服务提供商网络**。是目前事实上的标准。

#### 3. 联盟

*   **优点**：
    *   **天然的故障域隔离**：将一个大的网络问题分解到多个子AS中，便于管理和故障排查。
    *   **策略灵活性强**：在子AS边界，可以像使用eBGP一样应用丰富的路由策略（如MED、AS_PATH预挂等），提供了比RR更精细的控制粒度。
    *   **无单点故障**：类似于全互联，在子AS内部是全互联或RR，但子AS之间是网状连接，没有中心化的反射器。
*   **缺点**：
    *   **配置和管理最复杂**：需要规划子AS的划分、分配私有AS号，并配置所有子AS边界路由器。
    *   **迁移困难**：从现有网络迁移到联盟架构通常需要详细的计划和可能的业务中断。
    *   **调试复杂度增加**：在排查问题时，需要同时关注AS_PATH和AS_CONFED_SEQUENCE。
*   **适用场景**：
    *   规模极其庞大、结构复杂且由多个独立管理区域组成的网络（例如超大型运营商、经历了多次合并的网络）。
    *   对策略控制有极高要求的特殊场景。

---

### 组合使用

在实际网络中，这三种方案并非互斥，经常被**组合使用**以发挥最大效益。

**最常见的组合是：路由反射器 + 联盟**

*   在一个超大型的联盟AS内，每个子AS的内部可能仍然很大。
*   此时，可以在**每个子AS内部使用路由反射器**来进一步减少iBGP会话数量。
*   这样既获得了联盟的故障隔离和策略灵活性，又享受了RR在子AS内部的扩展性优势。

### 总结

*   **全互联**是“教科书式”的基准，但不可用于生产大型网络。
*   **路由反射器**是当今的“主流选择”，在扩展性和易用性之间取得了最佳平衡。
*   **联盟**是“高级武器”，提供了最强的控制力和隔离性，但代价是极高的复杂性。

选择哪种方案取决于您的网络规模、增长预期、运维团队的技术能力和对网络控制力的具体要求。对于绝大多数网络而言，**路由反射器**都是首选方案。
