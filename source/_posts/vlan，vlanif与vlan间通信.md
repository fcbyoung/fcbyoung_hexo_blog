---
title: vlan，vlanif与vlan间通信
date: 2025-10-24 16:56:18
tags: [计算机网络,网络工程师,交换机,vlan]
---

## 一.vlan

交换机划分vlan后，不同vlan间无法通过二层直接通信，需经过三层的路由进行通信。

- **一个常见的比喻：**

  - **VLAN** 就像一栋大楼里的**不同楼层**。二层通信就像楼层内部的人可以互相喊话（广播）和传递纸条（单播）。

  - **路由** 就像大楼里的**电梯/楼梯**。不同楼层的人要通信，必须经过电梯/楼梯（路由）才能到达另一个楼层。

    

### 二.vlan间通信

首先，我们要明确一个核心矛盾：

1. **VLAN的初衷是隔离**：划分VLAN的主要目的是隔离广播域，增强网络安全性，简化管理。**默认情况下，不同VLAN之间的设备是无法通信的**。
2. **业务需求是互通**：在实际网络中，不同部门（处于不同VLAN）可能需要访问共同的服务器（如财务服务器、文件服务器），或者需要访问互联网。这就产生了跨VLAN的通信需求。

**结论**：VLAN解决了“不该通的不能通”的问题，而VLAN间通信则是在此基础上，解决“该通的如何通”的问题。

常用的方式有单臂路由，vlanif等。



### 三.单臂路由

这是一种经典但目前已较少在核心网络中使用的方法。

- **核心思想**：使用一个物理路由器，通过一个物理接口连接交换机。交换机与路由器相连的接口配置为**Trunk**口，允许多个VLAN的流量通过。
- **实现方式**：在路由器和交换机相连的物理接口上创建多个**子接口**，每个子接口对应一个VLAN，并分配一个IP地址作为该VLAN的**网关**。
- **工作过程**：
  1. PC1 (VLAN 10) 要发送数据给 PC2 (VLAN 20)。
  2. 数据帧被打上VLAN 10的标签，通过Trunk链路发送给路由器。
  3. 路由器收到后，由其子接口处理，剥掉VLAN标签，进行路由查询。
  4. 发现目标网络在VLAN 20，于是通过对应的VLAN 20子接口将数据帧发出，并重新打上VLAN 20的标签。
  5. 交换机收到带VLAN 20标签的帧，将其转发给PC2。
- **优缺点**：
  - **优点**：概念清晰，利用现有路由器设备。
  - **缺点**：**路由器成为性能和单点故障的瓶颈**，所有跨VLAN流量都要经过这一条物理链路（“单臂”），容易形成拥堵。
  - 

### 四.vlanif

- **核心思想**：将路由功能集成到交换机内部。三层交换机既具备二层交换的所有功能，也具备三层路由功能。
- **关键组件：VLANIF接口**
  - **什么是VLANIF？** 它是一个**逻辑的三层接口**，也常被称为 **SVI**。它不是物理存在的，而是通过命令行创建的。
  - **作用**：为每个VLAN创建一个VLANIF接口，并为其分配IP地址。**这个IP地址就充当了该VLAN内所有设备的默认网关**。
  - **位置**：路由功能在三层交换机内部的高速ASIC芯片中完成，速度极快，可以达到“线速路由”。
- **工作过程**：
  1. 在三层交换机上为VLAN 10创建VLANIF 10，配置IP地址`192.168.10.1/24`；为VLAN 20创建VLANIF 20，配置IP地址`192.168.20.1/24`。
  2. PC1 (VLAN 10， IP `192.168.10.2`) 要访问 PC2 (VLAN 20， IP `192.168.20.2`)。
  3. PC1判断目标PC2与自己不在同一网段，于是将数据包发送给自己的网关`192.168.10.1`（即交换机的VLANIF 10接口）。
  4. 数据包进入交换机后，**在内部从二层交换流程上送到三层路由引擎**。
  5. 三层引擎查询路由表，发现目标网络`192.168.20.0/24` 是直连路由，出接口是VLANIF 20。
  6. 于是，数据包被重新封装，源MAC地址改为VLANIF 20的MAC，目的MAC改为PC2的MAC。
  7. 交换机根据目标MAC地址，将数据包从属于VLAN 20的端口转发给PC2。
- **优缺点**：
  - **优点**：
    - **高性能**：基于硬件转发，速度远快于传统路由器。
    - **低延迟**：无需离开设备，内部完成路由。
    - **简化拓扑**：无需外接路由器，网络结构更简洁。
  - **缺点**：成本比二层交换机高。

### 总结：

1. **根本原理**：VLAN间通信的本质是**三层路由**。数据包必须经过一个具有路由功能的设备（路由器或三层交换机）。

2. **VLANIF的核心角色**：

   - 它是**VLAN的网关接口**。每个需要与外部通信的VLAN都需要一个VLANIF接口。
   - 它是一个**逻辑的三层接口**，是三层路由功能的入口和出口。
   - 它的IP地址是所在VLAN内所有主机的**默认网关**。

3. **通信流程简化模型**：

   - **源主机** -> **发送到本VLAN的网关（VLANIF）** -> **三层设备路由** -> **从目标VLAN的网关（VLANIF）送出** -> **目标主机**

4. **配置示例（以华为三层交换机为例）**：

   bash

   ```
   # 创建VLAN
   <Switch> system-view
   [Switch] vlan batch 10 20
   
   # 将端口加入VLAN (假设G0/0/1属于VLAN10， G0/0/2属于VLAN20)
   [Switch] interface gigabitethernet 0/0/1
   [Switch-GigabitEthernet0/0/1] port link-type access
   [Switch-GigabitEthernet0/0/1] port default vlan 10
   [Switch] interface gigabitethernet 0/0/2
   [Switch-GigabitEthernet0/0/2] port link-type access
   [Switch-GigabitEthernet0/0/2] port default vlan 20
   
   # 创建VLANIF接口并配置IP地址（网关）
   [Switch] interface vlanif 10
   [Switch-Vlanif10] ip address 192.168.10.1 255.255.255.0
   [Switch] interface vlanif 20
   [Switch-Vlanif20] ip address 192.168.20.1 255.255.255.0
   ```

   

   完成以上配置后，VLAN 10和VLAN 20之间就可以互相通信了。

### 总结对比表

| 特性         | 单臂路由（传统路由器）   | 三层交换机（VLANIF）     |
| :----------- | :----------------------- | :----------------------- |
| **核心设备** | 物理路由器               | 三层交换机               |
| **实现接口** | 物理接口的子接口         | 逻辑VLANIF接口           |
| **性能**     | 低，受CPU和链路带宽限制  | 高，硬件ASIC线速转发     |
| **延迟**     | 较高                     | 极低                     |
| **网络拓扑** | 复杂，需要Trunk链路      | 简洁，设备内部完成       |
| **成本**     | 可能较低（利用现有设备） | 较高（三层交换机更贵）   |
| **适用场景** | 小型网络，临时需求       | 中大型企业网、园区网核心 |

