---
title: vlan与交换机
date: 2025-10-24 16:37:13
tags: [网络工程师,计算机网络,交换机,vlan]
---

## 一.vlan

vlan可以将统一物理局域网内不同用户从逻辑上划分为不同广播域，不同vlan间隔离广播域。

vlan范围0~4095,0和4095不可用。vlan 1为默认vlan。

相同vlan间的主机可基于二层通信，不同vlan主机不可基于二层通信。

（意思是不同vlan间主机可基于单臂路由，或vlanif等方式从三层建立通信渠道）



## 二.与vlan相关的三种交换机模式

## (1)access

我们可以把Access接口的工作过程想象成一个**严格的“门卫”**，它只允许属于特定VLAN（即缺省VLAN）的流量通过，并且会帮数据帧“穿上”或“脱掉”制服（VLAN标签）。

**核心概念：**
*   **PVID (Port VLAN ID)**： 端口的缺省VLAN ID。这是Access接口最重要的属性，可以理解为这个接口的“身份牌”。
*   **VID (VLAN ID)**： 数据帧本身携带的VLAN标签中的ID。
*   **Tag (标签)**： 数据帧在交换机内部传输时，为了区分属于哪个VLAN而加上的一个4字节的报头。

---

#### 详细解读：

1.  **“可以使用接口VLAN编号(PVID)对数据帧封装和剥离VLAN标签(VID)，可以传输一个VLAN流量。通常用于交换机与PC相连接。”**
    *   **理解**： 这句话是总述。它点明了Access接口的两个核心功能（打标签和撕标签）和它的根本特性（只能属于一个VLAN）。应用场景是连接PC、服务器、打印机等**通常不支持VLAN标签的设备**。

2.  **“(1)对接收不带Tag的报文处理”**
    *   **场景**： 一台PC发送一个普通的以太网数据帧给交换机。PC根本不知道VLAN是什么，所以发送的帧是“原始的”、不带Tag的。
    *   **动作**： 交换机Access接口的“门卫”看到这个没穿制服的帧，会根据自己身上的身份牌（PVID），给它穿上对应的制服（打上PVID值的VLAN标签）。然后这个帧才能在交换机内部转发。

3.  **“(2)对接收带Tag的报文处理”**
    *   **场景**： 这种情况较少见于终端设备，但可能发生在配置错误或网络攻击时。一个带着VLAN标签的帧到达了Access接口。
    *   **动作**： “门卫”会检查这个帧的制服号码（VID）是否和自己的身份牌（PVID）一致。
        *   **① 相同**： 罕见但允许的情况。比如这个帧是从另一个配置了相同PVID的Access接口发过来的（可能是配置失误）。门卫会放行。
        *   **② 不同**： 这是绝大多数情况。门卫认为“这不是我们部门的人，穿错制服了”，会直接丢弃该报文。**这是Access接口实现VLAN隔离的关键一步。**

4.  **“(3)发送帧处理过程”**
    *   **场景**： 交换机需要将一个数据帧从这个Access接口发送给相连的PC。
    *   **动作**： 数据帧在交换机内部是穿着制服（带Tag）的。在发出接口前，“门卫”会帮它把制服脱掉（剥离VLAN标签），还原成一个普通的以太网帧，再发送给PC。因为PC不希望、也看不懂VLAN标签。

---

### 总结与补充

#### 1. 核心特点总结

*   **单向VLAN成员关系**： 一个Access接口在某一时刻**只能属于一个VLAN**。这是它和Trunk、Hybrid接口最根本的区别。
*   **安全与隔离**： 其“丢弃与PVID不同Tag的帧”的行为，是实现VLAN间二层隔离的基础，增强了网络安全性。
*   **即插即用**： 对于下联设备（如PC）来说，它完全感知不到VLAN的存在，简化了终端配置。

#### 2. 配置相关

*   **配置命令（以华为/华三设备为例）**：
    ```bash
    interface GigabitEthernet 0/0/1    # 进入接口视图
    port link-type access               # 将接口模式设置为Access
    port default vlan 10               # 设置接口的PVID为10
    ```
    不进行这些配置，接口通常默认为`Hybrid`模式，PVID为1，行为会不符合预期。

#### 3. 常见应用场景扩展

*   **连接终端用户设备**： 如PC、IP电话（语音VLAN通常用其他方式处理）、打印机。
*   **连接服务器**： 如果服务器只需要在一个VLAN内通信。
*   **连接路由器或防火墙的接口**： 当需要实现“单臂路由”或VLAN间路由时，连接路由器的交换机接口通常配置为Access模式，属于一个特定的VLAN。

### 一个简单的比喻

*   **公司部门**： 每个VLAN就像一个部门（如财务部VLAN 10，技术部VLAN 20）。
*   **Access接口**： 就像是每个员工的工位网口。这个网口只属于他所在的部门（PVID=部门号）。
*   **接收不带Tag的帧**： 员工在自己工位写了一封普通信件（数据帧），交给交换机。交换机会在信上盖一个“财务部”（VLAN 10）的章（Tag），然后只在财务部内部传递。
*   **接收带Tag的帧**： 如果一封盖着“技术部”章的信误传到财务部员工的工位，工位网口（Access接口）会直接把这封信扔掉（丢弃），确保财务部的网络不会收到技术部的广播流量。
*   **发送帧**： 当有信从交换机发给员工时，交换机会在发出前把“财务部”的章撕掉，员工看到的还是一封普通信件。

## (2)trunk

Trunk接口是交换机互联的关键，理解它对于构建复杂网络至关重要。

### 详细解读

我们可以把Trunk接口想象成一个**高速公路的收费站/检查站**，它负责管理多条"车道"（多个VLAN）的流量，确保每辆车（数据帧）都在正确的车道上行驶。

**核心概念（在Access基础上新增）：**
*   **允许通过的VLAN列表（Allowed VLAN List）**：这是Trunk接口最重要的特性之一，定义了哪些VLAN的流量可以通行。
*   **PVID在Trunk中的特殊作用**：除了处理无标签帧，还决定了哪个VLAN的帧在发送时会被"隐藏身份"（去标签）。

---

#### 对原文的解读：

**1. "可以使用接口VLAN编号(PVID)对数据帧封装和剥离VLAN标签(VID)，可以传输多个VLAN流量。通常用于交换机之间互联。"**
*   **理解**：这句话点明了Trunk接口与Access接口的根本区别——**多VLAN传输能力**。应用场景是**交换机之间的互联**，用于在骨干链路上承载多个VLAN的流量。

**2. "(1)对接收不带Tag的报文处理"**

*   **场景**：一台不支持VLAN的设备（如老式交换机或配置错误的设备）向Trunk接口发送了无标签帧。
*   **动作**：Trunk接口的"收费员"看到这辆没有"通行证"（Tag）的车，会给它发放一个默认的"临时通行证"（打上PVID）。
    *   **① PVID在允许列表中**：检查这个临时通行证（PVID）是否在允许通行的VLAN名单里。如果在，就放行这辆车。
    *   **② PVID不在允许列表中**：如果临时通行证不在名单上，则拒绝这辆车进入高速（丢弃报文）。**这是一种安全机制，防止未知VLAN的流量进入网络。**

**3. "(2)对接收带Tag的报文处理"**
*   **场景**：这是Trunk接口的正常工作场景。从另一台交换机收到了带有明确VLAN标签的帧。
*   **动作**："收费员"直接检查车辆自带的"通行证"（VLAN ID）。
    *   **① VLAN ID在允许列表中**：通行证有效，允许进入相应车道（接收报文）。
    *   **② VLAN ID不在允许列表中**：通行证无效，禁止进入（丢弃报文）。**这是实现VLAN修剪（VLAN Pruning）的关键，可以手动控制哪些VLAN流量可以通过Trunk链路，避免不必要的广播流量泛滥。**

**4. "(3)发送帧处理过程"**
*   **场景**：交换机需要通过Trunk接口将数据帧发送给另一台交换机。这里的处理规则是Trunk接口最精妙的部分。
*   **动作**："收费员"在车辆出口处，根据它的目的地决定是否收回"通行证"。
    *   **① 当VLAN ID与PVID相同，且在允许列表中**：如果这辆车属于"本地车辆"（VLAN ID = PVID），就收回它的通行证（去掉Tag），让它以普通车辆（无标签帧）的身份出去。**这样做主要是为了兼容对端设备可能不支持VLAN的情况，但现代网络中，建议始终保持Tagged。**
    *   **② 当VLAN ID与PVID不同，但在允许列表中**：如果这辆车是"过境车辆"（VLAN ID ≠ PVID），则保留它的通行证（保持原有Tag），让它继续在高速上行驶。**这是Trunk接口的典型行为，确保对端交换机能够正确识别VLAN。**

---

### 总结与补充

#### 1. 核心特点总结

*   **多VLAN干线**：核心功能是**在一条物理链路上承载多个VLAN的流量**，极大提高了链路利用率。
*   **显式允许列表**：必须通过配置明确指定哪些VLAN可以通过（`allowed VLAN list`）。默认情况下，某些厂商的设备可能只允许缺省VLAN（VLAN 1）通过，这是一个常见的安全陷阱。
*   **PVID的"本地VLAN"概念**：在Trunk接口上，PVID通常被称为"**Native VLAN**"。这个VLAN的流量在发送时会被去标签，**因此要求互联的交换机Trunk接口的Native VLAN必须一致**，否则会导致安全问题和通信故障。

#### 2. 配置相关

*   **配置命令（以华为/华三设备为例）**：
    ```bash
    interface GigabitEthernet 0/0/24
    port link-type trunk                    # 设置接口为Trunk模式
    port trunk pvid vlan 10                 # （可选）设置Native VLAN为10，默认为1
    port trunk allow-pass vlan 10 20 30     # 允许VLAN 10, 20, 30的流量通过
    ```
    **注意**：如果不配置`allow-pass`，Trunk接口可能无法传递任何需要的VLAN流量。

#### 3. 实际应用中的关键考量

*   **Native VLAN的安全问题**：因为Native VLAN的帧是不带标签传输的，如果攻击者接入一个Access接口并将其PVID设置为Trunk的Native VLAN，他可能截获到其他VLAN的流量（如果交换机配置不当）。**最佳实践是：将Native VLAN设置为一个不使用的、专门的VLAN，而不是VLAN 1。**
*   **VLAN修剪**：只允许必要的VLAN通过Trunk链路。例如，一栋楼的接入交换机只需要允许本楼的用户VLAN和公共VLAN上行到核心，而不需要允许其他楼的VLAN，这样可以减少不必要的广播流量。
*   **与Access接口的对比记忆**：
    
    | 特性             | Access接口         | Trunk接口                          |
    | :--------------- | :----------------- | :--------------------------------- |
    | **VLAN数量**     | 1个                | 多个                               |
    | **主要用途**     | 接终端             | 接交换机/网络设备                  |
    | **接收无标签帧** | 打上PVID           | 打上PVID，并检查PVID是否在允许列表 |
    | **接收有标签帧** | 仅接受VID=PVID的帧 | 接受VID在允许列表中的帧            |
    | **发送帧**       | 总是去掉Tag        | 仅当VID=PVID时去掉Tag，否则保留    |

#### 4. 一个典型的Trunk应用场景

*   **场景**：一栋大楼的每层有一台接入交换机（Access Switch），通过Trunk链路连接到中心机房的核心交换机（Core Switch）。
*   **配置**：
    *   接入交换机Trunk口：`allow-pass vlan 10, 20`（本层的两个VLAN）
    *   核心交换机Trunk口：`allow-pass vlan 10, 20, 30, 40, 99`（所有楼的VLAN和一个管理VLAN）
*   **工作流程**：
    1.  三楼用户（VLAN 10）发数据到服务器（VLAN 99）。
    2.  接入交换机通过Access接口收到无标签帧，打上VLAN 10标签。
    3.  查询MAC地址表后，决定通过Trunk口发送给核心交换机。
    4.  因为VLAN 10 (≠ PVID) 在允许列表中，帧**带着VLAN 10标签**被发送。
    5.  核心交换机收到带标签的帧，识别出属于VLAN 10，进行路由转发到VLAN 99。
    6.  核心交换机将帧从连接服务器机房的Trunk口发出，因为VLAN 99在允许列表中，帧**带着VLAN 99标签**被发送。

### 比喻升级：从"门卫"到"高速公路收费站"

*   **Trunk链路**：连接两座城市（交换机）的高速公路。
*   **允许通过的VLAN列表**：收费站允许通行的车辆类型清单（小客车、货车、客车等）。
*   **接收带Tag的报文**：一辆挂着"货车"（VLAN 20）牌照的车驶来。收费站检查"货车"是否在允许通行的清单上。如果在，放行。
*   **Native VLAN (PVID)**：这条高速上的"本地车辆专用通道"。本地车辆（VLAN ID = PVID）通过时不需要显示牌照（无标签），但必须在清单上。
*   **发送帧处理**：车辆要驶出收费站。如果是本地车辆，就收起牌照（去标签）通过；如果是其他类型的车辆，就继续挂着牌照（带标签）通过。



## (3)hybrid

Hybrid接口是华为/华三交换机特有的模式，也是最灵活的一种接口模式。它融合了Access和Trunk的特性，提供了更精细的控制能力。

### 详细解读

我们可以把Hybrid接口想象成一个**高度智能的"多功能交通枢纽"**，它既能像Access接口那样处理终端设备，又能像Trunk接口那样处理多VLAN流量，而且还能对每个VLAN的"出入站规则"进行个性化设置。

**核心概念（Hybrid特有的）：**

*   **按VLAN配置发送行为**：这是Hybrid接口最核心的特性。对于每个允许通过的VLAN，都可以单独配置它在发送时是**带Tag（Tagged）** 还是**不带Tag（Untagged）**。

---

#### 详细解读：

**1. "可以使用接口VLAN编号(PVID)对数据帧封装和剥离VLAN标签(VID)，并具有多个VLAN标签的携带或剥离选择性配置，可以传输多个VLAN流量。可以用于交换机与PC相连接或交换机之间互联。"**

*   **理解**：这句话概括了Hybrid接口的最大特点——**灵活性**。它既具备Access接口的打标签/去标签能力，又具备Trunk接口的多VLAN传输能力，而且还能**选择性**地控制每个VLAN的标签处理方式。因此它应用场景非常广泛。

**2. "(1)对接收不带Tag的报文处理"**

*   **场景**：与Trunk接口完全一致。一个终端设备（如PC）发送无标签帧到Hybrid接口。
*   **动作**：
    *   **① PVID在允许列表中**：打上PVID，接收报文。
    *   **② PVID不在允许列表中**：打上PVID，但丢弃报文。**这说明Hybrid接口的接收逻辑与Trunk接口完全相同。**

**3. "(2)对接收带Tag的报文处理"**

*   **场景**：与Trunk接口完全一致。从网络设备收到带标签的帧。
*   **动作**：
    *   **① VLAN ID在允许列表中**：接收报文。
    *   **② VLAN ID不在允许列表中**：丢弃报文。**再次确认，Hybrid接口的接收逻辑与Trunk接口完全一致。**

**4. "(3)发送帧处理过程"**

*   **场景**：这是Hybrid接口与Trunk接口的**根本区别所在**！交换机要通过Hybrid接口发送一个数据帧。
*   **动作**：首先检查VLAN ID是否在允许列表中。如果在，则**不依赖于PVID，而是依赖于管理员为该VLAN预先配置的指令**：
    *   **如果配置该VLAN为`tagged`**：则帧**带标签**发送。
    *   **如果配置该VLAN为`untagged`**：则帧**去标签**发送。

**注意**：原文"可以通过命令设置发送时是否携带Tag"是Hybrid接口的灵魂所在！

---

### 总结与补充

#### 1. 核心特点总结

*   **极致的灵活性**：Hybrid接口打破了Trunk接口"仅PVID对应VLAN可去标签发送"的限制，允许**为每一个VLAN独立指定发送时的标签状态**。
*   **接收行为与Trunk相同**：在数据帧的接收方向上，Hybrid接口的逻辑与Trunk接口完全一致。
*   **发送行为可定制**：在数据帧的发送方向上，Hybrid接口提供了最精细的控制粒度。

#### 2. 配置相关

*   **配置命令（华为/华三设备为例）**：
    ```bash
    interface GigabitEthernet 0/0/1
    port link-type hybrid                    # 设置接口为Hybrid模式
    port hybrid pvid vlan 10                 # 设置PVID（Native VLAN）为10
    port hybrid untagged vlan 10 20          # 设置VLAN 10和20以Untagged方式发送
    port hybrid tagged vlan 30 99            # 设置VLAN 30和99以Tagged方式发送
    ```
    **关键**：一个VLAN不能同时被配置为`tagged`和`untagged`，但一个接口上可以同时存在多个`tagged`和多个`untagged`的VLAN。

#### 3. 典型应用场景（这是理解Hybrid价值的关键）

**场景1：单线复用（连接IP电话和PC）**
*   **需求**：一台IP电话和一台PC共用一条网线连接到交换机。电话需要属于VLAN 10（语音VLAN），PC需要属于VLAN 20（数据VLAN）。
*   **解决方案**：
    *   交换机连接电话的接口配置为Hybrid。
    *   `port hybrid pvid vlan 20` （PC的无标签流量默认划入VLAN 20）
    *   `port hybrid untagged vlan 20` （发给PC的VLAN 20流量去标签）
    *   `port hybrid tagged vlan 10` （发给电话的VLAN 10流量带标签，电话能识别VLAN标签）
*   **效果**：一根网线同时传输两个VLAN的流量，且各自以正确格式送达终端。

**场景2：灵活的网络设备互联**

*   **需求**：连接另一台交换机，但希望VLAN 100（管理VLAN）以无标签形式传输（简化对端配置），其他业务VLAN（VLAN 10, 20, 30）以标准Trunk方式（带标签）传输。
*   **解决方案**：
    *   `port hybrid pvid vlan 100`
    *   `port hybrid untagged vlan 100`  // 管理VLAN去标签
    *   `port hybrid tagged vlan 10 20 30` // 业务VLAN带标签

#### 4. 三种接口模式对比总结

| 特性             | Access接口     | Trunk接口                                | Hybrid接口                                                   |
| :--------------- | :------------- | :--------------------------------------- | :----------------------------------------------------------- |
| **VLAN数量**     | 1个            | 多个                                     | 多个                                                         |
| **主要用途**     | 接终端         | 接网络设备                               | 接终端或网络设备                                             |
| **接收无标签帧** | 打上PVID       | 打上PVID，检查PVID是否允许               | 同Trunk                                                      |
| **接收有标签帧** | 仅接受VID=PVID | 接受VID在允许列表中                      | 同Trunk                                                      |
| **发送帧规则**   | 总是去掉Tag    | **VID=PVID：去标签<br>VID≠PVID：带标签** | **可配置：<br>指定VLAN去标签(Untagged)<br>指定VLAN带标签(Tagged)** |
| **灵活性**       | 低             | 中                                       | 高                                                           |

#### 5. 比喻升级：Hybrid作为"智能多功能交通枢纽"

*   **Hybrid接口**：一个大型国际机场的边检和登机口系统。
*   **允许通过的VLAN列表**：机场允许通行的国家/地区列表。
*   **接收处理**：与Trunk"收费站"逻辑相同，检查护照（VLAN标签）是否在允许名单上。
*   **发送处理（核心区别）**：在登机口（发送帧时），系统会根据乘客的目的地（VLAN ID）和预先设置的规定：
    *   **去标签（Untagged）**：飞往"国内航班"（如VLAN 10）的乘客，收回他们的护照（去标签），让他们像国内旅客一样登机。
    *   **带标签（Tagged）**：飞往"国际航班"（如VLAN 20, 30）的乘客，需要继续持有护照（带标签）登机。
    *   **关键**：这个规则不是基于乘客来自哪里（PVID），而是**基于他们的目的地**，并且可以由管理员为每个目的地（每个VLAN）单独设置。



### 三类接口核心总结

*   **Access**： 一个接口，一个VLAN。接终端。
*   **Trunk**： 一个接口，多个VLAN。接另一台交换机或路由器。允许带Tag的多个VLAN流量通过。
*   **Hybrid**： 一个接口，多个VLAN。混合模式，更灵活，可以手动指定哪些VLAN带Tag发送，哪些不带Tag发送。兼具Access和Trunk的部分特性。
